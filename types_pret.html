<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Gestion des Types de Pr√™ts - EF</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        input,
        button {
            margin: 5px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        input[type="text"],
        input[type="number"] {
            width: 180px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px 20px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .btn-edit {
            background-color: #f39c12;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .btn-delete {
            background-color: #e74c3c;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        
        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #34495e;
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .stats-section {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stats-item {
            display: inline-block;
            margin: 0 20px;
            font-size: 18px;
            font-weight: bold;
            color: #27ae60;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Gestion des Types de Pr√™ts de l'√âtablissement Financier</h1>

        <div class="stats-section">
            <div class="stats-item">
                <span id="total-types">0</span> Types de Pr√™ts
            </div>
            <div class="stats-item">
                Taux moyen: <span id="taux-moyen">0.00%</span>
            </div>
        </div>

        <div class="form-section">
            <h3>Ajouter / Modifier un Type de Pr√™t</h3>
            <input type="hidden" id="id">

            <div class="form-row">
                <input type="text" id="nom" placeholder="Nom du type de pr√™t" required>
                <input type="number" id="taux_annuel" placeholder="Taux annuel (%)" step="0.01" min="0" max="100" required>
                <input type="number" id="duree_max_mois" placeholder="Dur√©e max (mois)" min="1" required>
            </div>

            <div class="form-row">
                <input type="number" id="montant_min" placeholder="Montant min (‚Ç¨)" step="0.01" min="0" required>
                <input type="number" id="montant_max" placeholder="Montant max (‚Ç¨)" step="0.01" min="0" required>
            </div>

            <div class="form-row">
                <button onclick="ajouterOuModifier()">Ajouter / Modifier</button>
                <button onclick="resetForm()" style="background-color: #95a5a6;">Annuler</button>
            </div>
        </div>

        <div id="error-container"></div>

        <table id="table-types-pret">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nom</th>
                    <th>Taux Annuel</th>
                    <th>Dur√©e Max</th>
                    <th>Montant Min</th>
                    <th>Montant Max</th>
                    <th>Date de cr√©ation</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const apiBase = "http://localhost/tp-flightphpCrud/ws"; // Correction du chemin API

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 5000);
        }

        function ajax(method, url, data, callback) {
    const xhr = new XMLHttpRequest();
    xhr.open(method, apiBase + url, true);
    
    // D√©finir les headers appropri√©s selon la m√©thode
    if (method === 'POST' || method === 'PUT') {
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    }
    
    xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
            console.log(`R√©ponse ${method} ${url}:`, xhr.status, xhr.responseText); // Debug
            
            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    callback(response);
                } catch (e) {
                    console.error("Erreur de parsing JSON:", e);
                    console.error("R√©ponse re√ßue:", xhr.responseText);
                    showError("Erreur de communication avec le serveur");
                }
            } else {
                console.error("Erreur HTTP:", xhr.status, xhr.statusText);
                console.error("R√©ponse:", xhr.responseText);
                
                // Essayer de parser la r√©ponse d'erreur
                try {
                    const errorResponse = JSON.parse(xhr.responseText);
                    showError(errorResponse.error || `Erreur de communication avec le serveur (HTTP ${xhr.status})`);
                } catch (e) {
                    showError(`Erreur de communication avec le serveur (HTTP ${xhr.status})`);
                }
            }
        }
    };
    
    xhr.send(data);
}

        function chargerTypesPret() {
    ajax("GET", "/types-pret", null, (data) => {
        typesPretData = data || []; // Stocker les donn√©es globalement
        
        const tbody = document.querySelector("#table-types-pret tbody");
        tbody.innerHTML = "";

        let totalTaux = 0;

        if (data && data.length > 0) {
            data.forEach(type => {
                const tr = document.createElement("tr");
                
                tr.innerHTML = `
                    <td>${type.id}</td>
                    <td>${escapeHtml(type.nom)}</td>
                    <td>${parseFloat(type.taux_annuel).toFixed(2)}%</td>
                    <td>${type.duree_max_mois} mois</td>
                    <td>${parseFloat(type.montant_min).toFixed(2)} ‚Ç¨</td>
                    <td>${parseFloat(type.montant_max).toFixed(2)} ‚Ç¨</td>
                    <td>${type.created_at}</td>
                    <td>
                        <button class="btn-edit" onclick="remplirFormulaire(${type.id})">‚úèÔ∏è Modifier</button>
                        <button class="btn-delete" onclick="supprimerTypePret(${type.id})">üóëÔ∏è Supprimer</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
                totalTaux += parseFloat(type.taux_annuel);
            });
        }

        // Mettre √† jour les statistiques
        document.getElementById("total-types").textContent = data ? data.length : 0;
        const tauxMoyen = (data && data.length > 0) ? (totalTaux / data.length).toFixed(2) : 0;
        document.getElementById("taux-moyen").textContent = tauxMoyen + "%";
    });
}
// Fonction utilitaire pour √©chapper le HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Stocker les donn√©es des types de pr√™t globalement pour √©viter les probl√®mes JSON
let typesPretData = [];

        function ajouterOuModifier() {
            const id = document.getElementById("id").value;
            const nom = document.getElementById("nom").value.trim();
            const taux_annuel = document.getElementById("taux_annuel").value;
            const duree_max_mois = document.getElementById("duree_max_mois").value;
            const montant_min = document.getElementById("montant_min").value;
            const montant_max = document.getElementById("montant_max").value;

            // Validation
            if (!nom || !taux_annuel || !duree_max_mois || !montant_min || !montant_max) {
                showError("Veuillez remplir tous les champs obligatoires.");
                return;
            }

            if (parseFloat(montant_min) >= parseFloat(montant_max)) {
                showError("Le montant minimum doit √™tre inf√©rieur au montant maximum.");
                return;
            }

            if (parseFloat(taux_annuel) < 0 || parseFloat(taux_annuel) > 100) {
                showError("Le taux annuel doit √™tre compris entre 0 et 100%.");
                return;
            }

            const data = `nom=${encodeURIComponent(nom)}&taux_annuel=${encodeURIComponent(taux_annuel)}&duree_max_mois=${encodeURIComponent(duree_max_mois)}&montant_min=${encodeURIComponent(montant_min)}&montant_max=${encodeURIComponent(montant_max)}`;

            console.log("Donn√©es envoy√©es:", data); // Debug

            if (id) {
                ajax("PUT", `/types-pret/${id}`, data, (response) => {
                    resetForm();
                    chargerTypesPret();
                    alert("Type de pr√™t modifi√© avec succ√®s!");
                });
            } else {
                ajax("POST", "/types-pret", data, (response) => {
                    resetForm();
                    chargerTypesPret();
                    alert("Type de pr√™t ajout√© avec succ√®s!");
                });
            }
        }

        function remplirFormulaire(typeId) {
    const type = typesPretData.find(t => t.id == typeId);
    if (type) {
        document.getElementById("id").value = type.id;
        document.getElementById("nom").value = type.nom;
        document.getElementById("taux_annuel").value = type.taux_annuel;
        document.getElementById("duree_max_mois").value = type.duree_max_mois;
        document.getElementById("montant_min").value = type.montant_min;
        document.getElementById("montant_max").value = type.montant_max;
    }
}

        function supprimerTypePret(id) {
    if (confirm("√ätes-vous s√ªr de vouloir supprimer ce type de pr√™t ?")) {
        console.log(`Tentative de suppression du type de pr√™t ID: ${id}`); // Debug
        
        ajax("DELETE", `/types-pret/${id}`, null, (response) => {
            console.log("R√©ponse de suppression:", response); // Debug
            
            if (response.message) {
                alert("Type de pr√™t supprim√© avec succ√®s!");
                chargerTypesPret(); // Recharger la liste
            } else if (response.error) {
                showError(response.error);
            } else {
                showError("Erreur inconnue lors de la suppression");
            }
        });
    }
}

        function resetForm() {
            document.getElementById("id").value = "";
            document.getElementById("nom").value = "";
            document.getElementById("taux_annuel").value = "";
            document.getElementById("duree_max_mois").value = "";
            document.getElementById("montant_min").value = "";
            document.getElementById("montant_max").value = "";
        }

        // Charger les types de pr√™ts au d√©marrage
        chargerTypesPret();
    </script>

</body>

</html>