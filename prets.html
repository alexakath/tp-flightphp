<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des Pr√™ts - EF</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        input, select, button {
            margin: 5px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        input[type="number"], select {
            width: 180px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px 20px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .btn-modify {
            background-color: #f1c40f;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .btn-delete {
            background-color: #e74c3c;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #34495e;
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        
        .stats-section {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stats-item {
            display: inline-block;
            margin: 0 20px;
            font-size: 18px;
            font-weight: bold;
            color: #27ae60;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gestion des Pr√™ts - √âtablissement Financier</h1>

        <div class="stats-section">
            <div class="stats-item">Solde Total: <span id="solde-total">0.00 ‚Ç¨</span></div>
            <div class="stats-item">Total Pr√™ts: <span id="total-prets">0</span></div>
        </div>

        <div class="form-section">
            <h3 id="form-title">Soumettre une Demande de Pr√™t</h3>
            <div class="form-row">
                <select id="client_id" required>
                    <option value="">S√©lectionner un client</option>
                </select>
                <select id="type_pret_id" required>
                    <option value="">S√©lectionner un type de pr√™t</option>
                </select>
                <input type="number" id="montant" placeholder="Montant (‚Ç¨)" step="0.01" min="0" required>
            </div>
            <div class="form-row">
                <input type="number" id="duree" placeholder="Dur√©e (mois)" min="1" required>
                <input type="date" id="date_debut" placeholder="Date de d√©but" required>
            </div>
            <div class="form-row">
                <button id="submit-btn" onclick="soumettrePret()">Soumettre</button>
                <button onclick="resetForm()" style="background-color: #95a5a6;">Annuler</button>
            </div>
        </div>

        <div id="error-container"></div>

        <table id="table-prets">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Client</th>
                    <th>Type de Pr√™t</th>
                    <th>Montant</th>
                    <th>Dur√©e</th>
                    <th>Date de D√©but</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const apiBase = "http://localhost/tp-flightphp/ws";
        let currentPretId = null;

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => errorContainer.innerHTML = '', 5000);
        }

        function ajax(method, url, data, callback) {
            const xhr = new XMLHttpRequest();
            xhr.open(method, apiBase + url, true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            callback(response);
                        } catch (e) {
                            console.error("Erreur de parsing JSON:", e);
                            showError("Erreur de communication avec le serveur");
                        }
                    } else {
                        console.error("Erreur HTTP:", xhr.status, xhr.statusText);
                        showError(`Erreur de communication avec le serveur (HTTP ${xhr.status})`);
                    }
                }
            };
            xhr.send(data);
        }

        function chargerSoldeTotal() {
            ajax("GET", "/fonds/solde-total", null, (data) => {
                const solde = data.solde_total ? parseFloat(data.solde_total).toFixed(2) : "0.00";
                document.getElementById("solde-total").textContent = solde + " ‚Ç¨";
            });
        }

        function chargerClients() {
            ajax("GET", "/clients", null, (data) => {
                const select = document.getElementById("client_id");
                select.innerHTML = '<option value="">S√©lectionner un client</option>';
                if (data && data.length > 0) {
                    data.forEach(client => {
                        const option = document.createElement("option");
                        option.value = client.id;
                        option.textContent = client.nom;
                        select.appendChild(option);
                    });
                }
            });
        }

        function chargerTypesPret() {
            ajax("GET", "/types-pret", null, (data) => {
                const select = document.getElementById("type_pret_id");
                select.innerHTML = '<option value="">S√©lectionner un type de pr√™t</option>';
                if (data && data.length > 0) {
                    data.forEach(type => {
                        const option = document.createElement("option");
                        option.value = type.id;
                        option.textContent = type.nom;
                        select.appendChild(option);
                    });
                }
            });
        }

        function chargerPrets() {
            ajax("GET", "/prets", null, (data) => {
                const tbody = document.querySelector("#table-prets tbody");
                tbody.innerHTML = "";
                document.getElementById("total-prets").textContent = data ? data.length : 0;

                if (data && data.length > 0) {
                    data.forEach(pret => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${pret.id}</td>
                            <td>${pret.client_nom}</td>
                            <td>${pret.type_pret_nom}</td>
                            <td>${parseFloat(pret.montant).toFixed(2)} ‚Ç¨</td>
                            <td>${pret.duree} mois</td>
                            <td>${pret.date_debut}</td>
                            <td>
                                <button class="btn-modify" onclick="modifierPret(${pret.id}, '${pret.client_id}', '${pret.type_pret_id}', ${pret.montant}, ${pret.duree}, '${pret.date_debut}')">‚úèÔ∏è Modifier</button>
                                <button class="btn-delete" onclick="supprimerPret(${pret.id})">üóëÔ∏è Supprimer</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            });
        }

        function soumettrePret() {
            const client_id = document.getElementById("client_id").value;
            const type_pret_id = document.getElementById("type_pret_id").value;
            const montant = document.getElementById("montant").value;
            const duree = document.getElementById("duree").value;
            const date_debut = document.getElementById("date_debut").value;

            if (!client_id || !type_pret_id || !montant || !duree || !date_debut) {
                showError("Veuillez remplir tous les champs obligatoires.");
                return;
            }

            const data = `client_id=${encodeURIComponent(client_id)}&type_pret_id=${encodeURIComponent(type_pret_id)}&montant=${encodeURIComponent(montant)}&duree=${encodeURIComponent(duree)}&date_debut=${encodeURIComponent(date_debut)}`;

            const method = currentPretId ? "PUT" : "POST";
            const url = currentPretId ? `/prets/${currentPretId}` : "/prets";

            ajax(method, url, data, (response) => {
                if (response.error) {
                    showError(response.error);
                } else {
                    resetForm();
                    chargerPrets();
                    chargerSoldeTotal();
                    alert(currentPretId ? "Pr√™t modifi√© avec succ√®s !" : "Demande de pr√™t soumise avec succ√®s !");
                }
            });
        }

        function modifierPret(id, client_id, type_pret_id, montant, duree, date_debut) {
            currentPretId = id;
            document.getElementById("form-title").textContent = "Modifier une Demande de Pr√™t";
            document.getElementById("submit-btn").textContent = "Modifier";
            document.getElementById("client_id").value = client_id;
            document.getElementById("type_pret_id").value = type_pret_id;
            document.getElementById("montant").value = montant;
            document.getElementById("duree").value = duree;
            document.getElementById("date_debut").value = date_debut;
        }

        function supprimerPret(id) {
            if (confirm("√ätes-vous s√ªr de vouloir supprimer ce pr√™t ?")) {
                ajax("DELETE", `/prets/${id}`, null, (response) => {
                    if (response.error) {
                        showError(response.error);
                    } else {
                        chargerPrets();
                        chargerSoldeTotal();
                        alert("Pr√™t supprim√© avec succ√®s !");
                    }
                });
            }
        }

        function resetForm() {
            currentPretId = null;
            document.getElementById("form-title").textContent = "Soumettre une Demande de Pr√™t";
            document.getElementById("submit-btn").textContent = "Soumettre";
            document.getElementById("client_id").value = "";
            document.getElementById("type_pret_id").value = "";
            document.getElementById("montant").value = "";
            document.getElementById("duree").value = "";
            document.getElementById("date_debut").value = new Date().toISOString().split('T')[0];
        }

        // Initialiser la date du jour
        document.getElementById("date_debut").value = new Date().toISOString().split('T')[0];

        // Charger les donn√©es au d√©marrage
        chargerSoldeTotal();
        chargerClients();
        chargerTypesPret();
        chargerPrets();
    </script>
</body>
</html>